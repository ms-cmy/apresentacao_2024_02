name: Terraform deployment
on:
  push:
    branches: [ "master" ]

jobs:
  deploy-artifact-registry:
      runs-on: ubuntu-latest
    
      steps:
        - name: Checkout the repository to the runner
          uses: actions/checkout@v2
    
        - name: Setup Terraform with specified version on the runner
          uses: hashicorp/setup-terraform@v2
        
        - name: auth to google
          uses: 'google-github-actions/auth@v2'
          with:
            credentials_json: ${{ secrets.GOOGLE_CREDENTIALS }}
        
        - name: terraform init
          run: | 
            cd terraform/artifact_registry
            terraform init
            terraform plan
            terraform validate
            terraform apply -auto-approve
  deploy-docker-to-registry:
      needs: deploy-artifact-registry
      runs-on: ubuntu-latest

      steps:
        - name: Checkout the repository to the runner
          uses: actions/checkout@v2
        
        - name: auth to google
          uses: 'google-github-actions/auth@v2'
          with:
            credentials_json: ${{ secrets.GOOGLE_CREDENTIALS }}
        
        - name: auth to google docker
          run: gcloud auth configure-docker us-central1-docker.pkg.dev --project silicon-garage-438603-m6
    
        - name: Build the Docker image
          run: docker build . --file dockerfile --tag us-central1-docker.pkg.dev/silicon-garage-438603-m6/mycloudrun-repo/model_api:latest
        
        - name: Run shell script
          run: docker push us-central1-docker.pkg.dev/silicon-garage-438603-m6/mycloudrun-repo/model_api:latest